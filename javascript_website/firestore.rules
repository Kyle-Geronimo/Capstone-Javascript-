rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: check if user is admin
    function isAdmin() {
      return isSignedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper: check if user is an employee/staff
    function isEmployee() {
      return isSignedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'employee';
    }

    // -------------------------
    // Account requests (public create)
    // -------------------------
    match /accountRequests/{requestId} {
      // Anyone may submit a signup request
      allow create: if true;
      // Only admins can read/update/delete requests
      allow read, update, delete: if isAdmin();
    }

    // -------------------------
    // Users collection
    // -------------------------
    match /users/{userId} {
      // Signed-in users can read profiles (tweak if you want tighter privacy)
      allow read: if isSignedIn();

      // Create: allow a user to create their own profile document
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Update/delete: owner or admin can modify
      allow update, delete: if isSignedIn() && (request.auth.uid == userId || isAdmin());

      // Admins can also write to users collection
      allow write: if isAdmin();
    }

    // -------------------------
    // Archived users (admin-only)
    // -------------------------
    match /archivedUsers/{docId} {
      allow read, write: if isAdmin();
    }

    // -------------------------
    // Attendance
    // -------------------------
    match /attendance/{docId} {
      // Signed-in users can read attendance (adjust if you prefer more restriction)
      allow read: if isSignedIn();

      // Create: allow user to create their own attendance record (use request.resource for incoming data)
      allow create: if isSignedIn() && (request.auth.uid == request.resource.data.userId || isAdmin());

      // Update: owner or admin can update (resource exists on update)
      allow update: if isSignedIn() && (request.auth.uid == resource.data.userId || isAdmin());

      // Delete: admin-only
      allow delete: if isAdmin();
    }

    // -------------------------
    // Payroll runs (top-level collection "payrolls")
    // -------------------------
    match /payrolls/{payrollId} {
      // Admins create payroll runs
      allow create: if isAdmin();

      // Read run metadata: admins or the creator
      allow read: if isAdmin() || (resource.data.createdBy == request.auth.uid);

      // Update/delete: admin only
      allow update, delete: if isAdmin();

      // Lines subcollection rules (see below)
      match /lines/{lineId} {
        // Admins can read all lines; employee can read their own line (document id = their uid)
        allow read: if isAdmin() || (request.auth != null && request.auth.uid == lineId);

        // Writes to payroll lines are admin-only (prevents users from spoofing lines)
        allow create, update, delete: if isAdmin();
      }
    }

    // -------------------------
    // Payroll batches (admin-only)
    // -------------------------
    match /payrollBatches/{batchId} {
      allow read, write, delete: if isAdmin();
    }

    // -------------------------
    // Chatbot inquiries
    // -------------------------
    match /chatbot/{docId} {
      // Any signed-in user may create
      allow create: if isSignedIn();

      // Admins and employees may read (adjust if needed)
      allow read: if isAdmin() || isEmployee();

      // Only admins can edit or delete
      allow update, delete: if isAdmin();
    }

    // Default: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
