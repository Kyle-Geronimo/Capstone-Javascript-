<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scanner â€” HRIS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --accent:#2563eb; --muted:#666; --card:#f7f9fc; }
    body{font-family:Inter, system-ui, Arial; margin:18px; color:#111}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    select,input,button{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    button.primary{background:var(--accent);color:#fff;border:none}
    #reader{width:480px;height:320px;border-radius:8px;border:1px solid #e6e6e6;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
    #status{margin-top:8px;padding:8px;border-radius:6px;background:#fafafa}
    .debug{margin-top:8px;padding:8px;background:#111;color:#9ff;max-height:160px;overflow:auto;font-family:monospace;font-size:12px}
    .small{font-size:13px}
    .tag{display:inline-block;padding:4px 8px;border-radius:6px;background:#e6f4ea;color:#0b4d2e;font-weight:700}
  </style>

  <!-- local copy of html5-qrcode (place it in public/vendor/) -->
  <script src="/vendor/html5-qrcode.min.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>QR Scanner</h1>
      <div class="muted">Scan employee QR to Check In / Check Out</div>
    </div>
    <div>
      <a class="small" href="/pages/admin.html">Admin</a> &nbsp;|&nbsp;
      <a class="small" href="/pages/payroll.html">Payroll</a>
    </div>
  </header>

  <section class="controls">
    <label>Action
      <select id="action">
        <option value="in">Check In</option>
        <option value="out">Check Out</option>
      </select>
    </label>

    <label>Camera
      <select id="cameraList"></select>
    </label>

    <button id="startBtn" class="primary">Start</button>
    <button id="stopBtn" disabled>Stop</button>

    <label style="margin-left:8px;">
      <input id="filePicker" type="file" accept="image/*" /> <span class="small muted">or upload QR image</span>
    </label>
    <button id="scanFileBtn">Scan file</button>
  </section>

  <div id="reader">Camera preview will appear here</div>
  <div id="status">Status: idle</div>

  <div class="debug" id="debug">Debug log...</div>

<script>
/*
Scanner page (patched)
- Uses res.text() when POSTing to /api/check so non-JSON responses are displayed for debugging
*/

const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');
const cameraSelect = document.getElementById('cameraList');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const filePicker = document.getElementById('filePicker');
const scanFileBtn = document.getElementById('scanFileBtn');
const actionSelect = document.getElementById('action');
const readerId = 'reader';

function dbg(msg){
  debugEl.textContent = (new Date()).toLocaleTimeString() + '  ' + msg + '\\n' + debugEl.textContent;
  console.log(msg);
}
function setStatus(msg, ok=true){
  statusEl.textContent = 'Status: ' + msg;
  statusEl.style.color = ok ? '#064e3b' : '#b91c1c';
}

if (typeof Html5Qrcode === 'undefined') {
  setStatus('html5-qrcode library not loaded. Copy minified file to /public/vendor/html5-qrcode.min.js', false);
  dbg('Html5Qrcode is not defined. Place the file: node_modules/html5-qrcode/minified/html5-qrcode.min.js -> public/vendor/html5-qrcode.min.js');
  throw new Error('Html5Qrcode not loaded');
}

let html5QrCode = null;
let currentCameraId = null;
const COOLDOWN_MS = 9000; // per-id
const GLOBAL_PAUSE_MS = 1500;
const lastSeen = {}; // map id -> timestamp

async function enumerateCams(){
  try{
    dbg('Enumerating cameras...');
    const cams = await Html5Qrcode.getCameras();
    cameraSelect.innerHTML = '';
    if(!cams || cams.length===0){
      cameraSelect.innerHTML = '<option value="">(no cameras)</option>';
      setStatus('No cameras found', false);
      dbg('No camera devices found.');
      return;
    }
    cams.forEach((c, idx) => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.text = c.label || ('Camera ' + (idx+1));
      cameraSelect.appendChild(opt);
    });
    currentCameraId = cams[0].id;
    cameraSelect.value = currentCameraId;
    setStatus('Cameras ready. Choose and Start.');
    dbg('Cameras found: ' + cams.map(x=>x.label||x.id).join(', '));
  }catch(err){
    dbg('Error enumerating cameras: ' + err);
    setStatus('Error enumerating cameras (see debug)', false);
  }
}

function pauseIfSupported(){
  try { if (html5QrCode && typeof html5QrCode.pause === 'function') html5QrCode.pause(); } catch(e){ dbg('pause error: '+e); }
}
function resumeIfSupported(){
  try { if (html5QrCode && typeof html5QrCode.resume === 'function') html5QrCode.resume(); } catch(e){ dbg('resume error: '+e); }
}

async function startCamera(deviceId){
  if(!deviceId){ setStatus('No camera selected', false); return; }
  if(!html5QrCode) html5QrCode = new Html5Qrcode(readerId);
  setStatus('Starting camera...');
  try {
    await html5QrCode.start(
      { deviceId: { exact: deviceId } },
      { fps: 10, qrbox: { width: 300, height: 200 } },
      onScanSuccess,
      onScanError
    );
    setStatus('Camera started - scanning...');
    startBtn.disabled = true; stopBtn.disabled = false;
    dbg('Camera started: ' + deviceId);
  } catch (e) {
    dbg('Start camera failed: ' + e);
    setStatus('Start camera failed: ' + e, false);
  }
}

async function stopCamera(){
  if(!html5QrCode) return;
  try {
    await html5QrCode.stop();
    setStatus('Camera stopped.');
    startBtn.disabled = false; stopBtn.disabled = true;
    dbg('Camera stopped');
  } catch (e) {
    dbg('Stop error: ' + e);
    setStatus('Stop error: ' + e, false);
  }
}

function onScanError(err){
  // minor decode errors ignored
}

async function onScanSuccess(decodedText, decodedResult){
  dbg('Decoded: ' + decodedText);
  let payload;
  try { payload = JSON.parse(decodedText); } catch(e){ setStatus('Invalid QR payload (not JSON)', false); dbg('Invalid QR: '+e); return; }
  if (!payload.id){ setStatus('QR missing id field', false); dbg('QR missing id'); return; }

  const now = Date.now();
  if (lastSeen[payload.id] && (now - lastSeen[payload.id] < COOLDOWN_MS)){
    dbg('Ignored duplicate scan for ' + payload.id);
    setStatus('Duplicate ignored', false);
    return;
  }
  lastSeen[payload.id] = now;
  pauseIfSupported();

  setStatus('Sending check to server...');
  try {
    const res = await fetch('/api/check', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: payload.id, action: actionSelect.value })
    });
    const text = await res.text();
    try {
      const j = JSON.parse(text);
      if (j.ok){
        setStatus(`OK: ${payload.id} ${j.event.action} at ${new Date(j.event.time).toLocaleString()}`);
        dbg('Server ok: ' + JSON.stringify(j));
      } else {
        setStatus('Server: ' + (j.error || 'unknown'), false);
        dbg('Server error: ' + JSON.stringify(j));
      }
    } catch (ex) {
      console.error('Non-JSON response for /api/check:', text);
      setStatus('Network error: see console (non-JSON response)', false);
      dbg('Raw response: ' + text);
    }
  } catch (err){
    setStatus('Network error: ' + err, false);
    dbg('Fetch error: ' + err);
    lastSeen[payload.id] = 0; // allow retry
  }

  setTimeout(()=> resumeIfSupported(), GLOBAL_PAUSE_MS);
}

async function scanImageFile(){
  const file = filePicker.files[0];
  if (!file){ setStatus('No file selected', false); return; }
  setStatus('Scanning image file...');
  dbg('Scanning file: ' + file.name);
  try {
    if(!html5QrCode) html5QrCode = new Html5Qrcode(readerId);
    if (typeof html5QrCode.scanFileV2 === 'function'){
      const result = await html5QrCode.scanFileV2(file, true);
      dbg('scanFileV2 result: ' + JSON.stringify(result));
      onScanSuccess(result.decodedText, result);
      return;
    }
    if (typeof Html5Qrcode.scanFile === 'function'){
      const result = await Html5Qrcode.scanFile(file, true);
      dbg('scanFile result: ' + JSON.stringify(result));
      onScanSuccess(result.decodedText, result);
      return;
    }
    setStatus('Image-scan API not available in this build', false);
    dbg('No scanFile API available');
  } catch (err){
    dbg('scanFile error: ' + err);
    setStatus('Image scan failed: ' + err, false);
  }
}

startBtn.addEventListener('click', ()=> { currentCameraId = cameraSelect.value; startCamera(currentCameraId); });
stopBtn.addEventListener('click', stopCamera);
scanFileBtn.addEventListener('click', scanImageFile);
cameraSelect.addEventListener('change', (e)=> { currentCameraId = e.target.value; dbg('Camera selected'); });

(async () => {
  try {
    dbg('Testing navigator.mediaDevices.getUserMedia...');
    await navigator.mediaDevices.getUserMedia({ video:true }).then(s => { s.getTracks().forEach(t=>t.stop()); dbg('Native getUserMedia OK'); });
  } catch (err){
    dbg('Native getUserMedia failed: ' + err);
    setStatus('Browser prevented camera access or none available', false);
  }
  await enumerateCams();
})();
</script>
</body>
</html>
