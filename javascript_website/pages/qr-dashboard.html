<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generate QR — HRIS</title>
  <link rel="icon" type="image/png" href="../image/logo/HTLogo.png">
  <link rel="stylesheet" href="../css/styles.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>
  <script type="module" src="../js/auth.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div style="display: flex; align-items: center; gap: 2rem;">
        <a href="payroll.html" class="nav-btn" style="background: #4f8cff; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none;">← Back</a>
        <h1>HotelLink</h1>
      </div>
    </div>
  </header>

  <main>
    <section class="form-container chatbot-data-container admin-dashboard">
      <h2>QR Dashboard</h2>

      <div class="admin-section">

        <div style="margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
          <!-- LEFT PANEL: GENERATOR -->
          <div>
            <h4 style="color: #1f4ea6; margin-top: 0; margin-bottom: 1rem;">Employee QR Generator</h4>
            <form id="createForm" class="qr-generator-form">
              <div class="form-row" style="margin-bottom: 1rem;">
                <label for="employeeSelect">Employee</label>
                <select id="employeeSelect" aria-label="Select employee">
                  <option value="">— select employee —</option>
                </select>

                <label for="roleField">Role</label>
                <input id="roleField" readonly placeholder="Auto-filled from users DB" aria-readonly="true" />

                <label for="department">Department</label>
                <select id="department" class="form-control" id="departmentSelect">
                  <option value="">— choose department —</option>
                  <option value="Bicotels Hotel">Bicotels Hotel</option>
                  <option value="D'Mariners Inn Hotel">D'Mariners Inn Hotel</option>
                  <option value="Wennrod Hotel">Wennrod Hotel</option>
                </select>

                <label for="shiftSelect">Shift</label>
                <select id="shiftSelect" class="form-control" aria-label="Select shift">
                  <option value="">— choose shift —</option>
                  <option value="morning">Morning Shift (06:00 - 13:59)</option>
                  <option value="mid">Mid Shift (14:00 - 21:59)</option>
                  <option value="night">Night Shift (22:00 - 05:59)</option>
                </select>
              </div>

              <button type="submit" class="action-btn primary">Generate QR</button>
            </form>

            <div id="resultArea" style="display:none; margin-top: 2rem; padding: 1.5rem; background: #f8f9fd; border-radius: 8px; border: 1px solid #e8ecf5;">
              <h3 style="color: #1f4ea6; margin-top: 0;">Employee created</h3>
              <div class="generator-result-info" id="info" style="margin-bottom: 1.5rem;"></div>
              <div class="generator-qr-preview" id="qrPreview" style="text-align: center; margin: 1.5rem 0;"></div>
              <div class="generator-result-buttons" style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                <button id="downloadBtn" class="action-btn">Download PNG</button>
                <button id="printBtn" class="action-btn">Print</button>
              </div>
            </div>

            <div id="status" style="margin-top: 1.5rem;"></div>
          </div>

          <!-- RIGHT PANEL: SCANNER -->
          <div>
            <h4 style="color: #1f4ea6; margin-top: 0; margin-bottom: 1rem;">QR Code Scanner</h4>

            <div class="scanner-controls">
              <div style="display:flex; gap:8px; align-items:center;">
                <button id="modeTimeIn" class="mode-btn">Time In</button>
                <button id="modeTimeOut" class="mode-btn">Time Out</button>
                <select id="cameraSelect" style="margin-left:8px;"></select>
              </div>

              <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                <button id="startCamera">Start</button>
                <button id="stopCamera">Stop</button>
                <button id="scanQrBtn">Scan QR</button>
                <button id="retryCameras">Retry Cameras</button>
                <input id="uploadQrImage" type="file" accept="image/png,image/jpeg" />
              </div>
            </div>

            <div id="cameraPreview" style="width:640px;height:480px;background:#000;margin-top:8px;"></div>

            <div id="scannerStatusLog" style="margin-top:8px; max-height:200px; overflow:auto; border:1px solid #eee; padding:8px;"></div>

            <details style="margin-top:8px;">
              <summary>Debug Log</summary>
              <div id="scannerDebugLog" style="max-height:200px; overflow:auto; padding:8px;"></div>
            </details>

            <p style="margin-top:8px;color:#666;">If no cameras appear, ensure your browser/site permissions allow camera access and try Retry Cameras. If the Html5Qrcode script is blocked by an extension, use the local vendor copy.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p style="text-align: center;">&copy; 2025 D' Mariners Inn Hotel. All rights reserved.</p>
    </div>
  </footer>
  
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
  <script src="../vendor/html5-qrcode.min.js"></script>
  <!-- Fallback QR decoder for image uploads -->
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    (function(){
      if (typeof Html5Qrcode === 'undefined') {
        var s = document.createElement('script');
        s.src = 'https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js';
        s.onload = function(){ console.log('Loaded Html5Qrcode from CDN fallback'); };
        s.onerror = function(){ console.warn('Failed to load Html5Qrcode from CDN (possibly blocked). If blocked, run `npm run copy-vendor` or copy node_modules/html5-qrcode/html5-qrcode.min.js to vendor/html5-qrcode.min.js'); };
        document.head.appendChild(s);
      }
    })();
  </script>

<script type="module">
  import { auth, db } from '../js/firebase-config.js';
  import { updateNavVisibility, highlightActiveNavBtn } from '../js/nav-control.js';
  import { initializeGenerator, initializeScanner } from '../js/qr.js';
  import { getDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js';


  updateNavVisibility();
  highlightActiveNavBtn();
  auth.onAuthStateChanged(() => { updateNavVisibility(); highlightActiveNavBtn(); });


  function waitForHtml5Qrcode(timeoutMs = 7000) {
    return new Promise((resolve, reject) => {
      if (window.Html5Qrcode) return resolve();
      const start = Date.now();
      const iv = setInterval(() => {
        if (window.Html5Qrcode) { clearInterval(iv); return resolve(); }
        if (Date.now() - start > timeoutMs) { clearInterval(iv); return reject(new Error('Html5Qrcode did not load within ' + timeoutMs + 'ms')); }
      }, 150);
    });
  }

  // Simple helper to create a full-screen PIN overlay with blurred background.
  function showPinOverlay(correctPin, userId) {
    return new Promise((resolve, reject) => {
      const overlay = document.createElement('div');
      overlay.id = 'qr-pin-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.zIndex = '9999';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.background = 'rgba(15,23,42,0.45)';
      overlay.style.backdropFilter = 'blur(6px)';

      overlay.innerHTML = `
        <div style="background:#fff;border-radius:16px;padding:24px 28px;max-width:360px;width:100%;box-shadow:0 18px 45px rgba(15,23,42,0.35);text-align:center;">
          <h2 style="margin:0 0 8px;font-size:1.2rem;color:#111827;">Admin PIN Required</h2>
          <p style="margin:0 0 16px;font-size:0.9rem;color:#4b5563;">Please enter your 6-digit PIN to access the QR Dashboard.</p>
          <input id="qr-pin-input" type="password" maxlength="6" inputmode="numeric" autocomplete="off"
                 style="font-size:1.4rem;letter-spacing:0.4em;text-align:center;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db;width:100%;box-sizing:border-box;" />
          <div id="qr-pin-error" style="min-height:18px;margin-top:8px;font-size:0.8rem;color:#b91c1c;"></div>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:16px;">
            <button id="qr-pin-cancel" type="button" class="action-btn" style="background:#e5e7eb;color:#374151;">Cancel</button>
            <button id="qr-pin-submit" type="button" class="action-btn primary">Unlock</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      const input = document.getElementById('qr-pin-input');
      const errEl = document.getElementById('qr-pin-error');
      const btnSubmit = document.getElementById('qr-pin-submit');
      const btnCancel = document.getElementById('qr-pin-cancel');
      let activeCorrectPin = String(correctPin);

      function cleanup(ok) {
        overlay.remove();
        (ok ? resolve() : reject(new Error('PIN cancelled or invalid')));
      }

      btnCancel.addEventListener('click', () => {
        cleanup(false);
      });

      function trySubmit() {
        const val = String(input.value || '').trim();
        if (!/^\d{6}$/.test(val)) {
          errEl.textContent = 'PIN must be exactly 6 digits.';
          return;
        }
        if (val !== activeCorrectPin) {
          errEl.textContent = 'Incorrect PIN.';
          return;
        }
        cleanup(true);
      }

      btnSubmit.addEventListener('click', trySubmit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); trySubmit(); }
      });

      setTimeout(() => { input.focus(); }, 50);
    });
  }

  // Wait for Firebase auth and then gate access by role + PIN using the overlay.
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    try {
      const snap = await getDoc(doc(db, 'users', user.uid));
      const data = snap.exists() ? snap.data() : {};
      const role = data.role || 'employee';

      if (role !== 'admin') {
        alert('Only admins can access the QR Dashboard.');
        window.location.href = 'payroll.html';
        return;
      }

      const storedPin = (data.pin ? String(data.pin) : '123456');

      // Show overlay immediately; only on success do we initialize the dashboard.
      try {
        await showPinOverlay(storedPin, user.uid);
      } catch (_) {
        window.location.href = 'payroll.html';
        return;
      }

      // PIN OK — proceed to initialize QR generator & scanner
      initializeGenerator();
      await waitForHtml5Qrcode(7000);
      console.log('Html5Qrcode available — initializing scanner.');
      initializeScanner();
    } catch (err) {
      console.error('Failed to initialize scanner (Html5Qrcode or PIN check issue):', err);
      const statusEl = document.getElementById('status-scanner') || document.getElementById('status');
      if (statusEl) {
        statusEl.textContent = 'Status: Unable to initialize QR dashboard. See console for details.';
        statusEl.className = 'utility-status error';
      }
    }
  });
</script>
</body>
</html>
