<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HotelLink - Sign Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="../image/logo/HTLogo.png">
  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="stylesheet" href="../css/auth-modern.css" />

  <!-- Inline background + glass (blur) styles for this page.
       These mirror the login page so the visual identity is consistent.
       Move into shared CSS if you'd like to avoid duplication. -->
  <style>
    body.auth-background {
      background-image:
        linear-gradient(180deg, rgba(246,250,255,0.56), rgba(245,247,255,0.56)),
        url('/image/bg/BG.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    body.auth-background::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(8, 18, 40, 0.28);
      pointer-events: none;
      z-index: 0;
    }

    .auth-form-col,
    .auth-page {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
    }

    .auth-card {
      background: rgba(255, 255, 255, 0.62);
      border: 1px solid rgba(255, 255, 255, 0.55);
      box-shadow: 0 18px 50px rgba(2, 6, 23, 0.26);
      border-radius: 14px;
      padding: 20px;
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      transition: transform 160ms ease, box-shadow 160ms ease;
    }

    .auth-card:focus-within,
    .auth-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 28px 70px rgba(2, 6, 23, 0.32);
    }

    .auth-card h2,
    .auth-card p,
    .auth-card label {
      color: #07102a;
    }

    @media (prefers-reduced-transparency: reduce), (prefers-reduced-motion: reduce) {
      .auth-card {
        background: #fff;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        transform: none !important;
        transition: none !important;
      }
      body.auth-background::before {
        background: rgba(8, 18, 40, 0.18);
      }
    }

    footer .container p {
      color: rgba(255,255,255,0.9);
      mix-blend-mode: lighten;
    }

    .show-password-btn { position: relative; z-index: 2; }
  </style>
</head>
<body class="auth-background">
  <header>
  </header>

  <main>
    <section class="auth-page signup-page" aria-labelledby="signup-title">
      <div class="auth-card" role="region" aria-labelledby="signup-title">
        <div class="card-head">
          <img src="/image/logo/HTLogo.png" alt="" style="width:44px;height:44px;border-radius:8px;background:transparent;" />
          <div>
            <h2 id="signup-title">Create an account</h2>
            <p class="sub">Sign up to get access to schedules, QR codes and staff tools.</p>
          </div>
        </div>

        <form id="signup-form" class="form-grid" novalidate>
          <div id="auth-announcer" aria-live="polite" class="visually-hidden"></div>

          <div class="field">
            <label for="signup-username" class="form-label">Full name</label>
            <div class="input-wrap" style="position:relative;">
              <div class="icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M3 20c1.5-3 4.5-5 9-5s7.5 2 9 5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <input id="signup-username" class="input form-control" type="text" placeholder="Your full name" />
            </div>
          </div>

          <div class="field">
            <label for="signup-email" class="form-label">Email</label>
            <div class="email-wrap input-wrap" style="position:relative;">
              <div class="icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M3 7.5L12 13L21 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="4" width="18" height="16" rx="3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </div>
              <input id="signup-email" class="input form-control" type="email" placeholder="you@hotel.com" required aria-required="true" />
            </div>
            <div class="email-notice helper">Note: Please use your business email as it will be visible to administrators.</div>
          </div>

          <div class="field">
            <label for="signup-password" class="form-label">Password</label>
            <div class="password-wrap input-wrap" style="position:relative;">
              <div class="icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <rect x="3" y="11" width="18" height="10" rx="2" stroke="currentColor" stroke-width="1.4"/>
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <input id="signup-password" class="input form-control" type="password" data-strength="true" placeholder="Create a password" required aria-required="true" />
            </div>
          </div>

          <div class="field">
            <label for="signup-role" class="form-label">Role</label>
            <select id="signup-role" class="form-control" aria-label="Select role">
              <option value="employee">Employee</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="button-container center-button" style="margin-top:8px;">
            <button id="signup-btn" class="btn-primary action-btn primary" type="submit">Sign Up</button>
          </div>

          <p class="auth-footer text-center">Already have an account? <a href="login.html" class="link-btn">Login</a></p>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Dâ€™ Mariners Inn Hotel. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
    import { auth } from '../js/firebase-config.js';
    import { signup } from '../js/auth.js';
    import { updateNavVisibility } from '../js/nav-control.js';
    import { initShowPassword } from '../js/show-password.js';
    import { initAuthEnhancements } from '../js/auth-enhancements.js';

    // Initialize helpers
    initShowPassword && typeof initShowPassword === 'function' && initShowPassword();
    initAuthEnhancements && typeof initAuthEnhancements === 'function' && initAuthEnhancements();

    updateNavVisibility && updateNavVisibility();

    // Helper to show a PIN overlay for admin signups
    function showAdminPinOverlay() {
      return new Promise((resolve, reject) => {
        const overlay = document.createElement('div');
        overlay.id = 'signup-pin-overlay';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.zIndex = '9999';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.background = 'rgba(15,23,42,0.45)';
        overlay.style.backdropFilter = 'blur(6px)';

        overlay.innerHTML = `
          <div style="background:#fff;border-radius:16px;padding:24px 28px;max-width:360px;width:100%;box-shadow:0 18px 45px rgba(15,23,42,0.35);text-align:center;">
            <h2 style="margin:0 0 8px;font-size:1.2rem;color:#111827;">Set Admin PIN</h2>
            <p style="margin:0 0 16px;font-size:0.9rem;color:#4b5563;">Create a 6-digit PIN. This will be used later to unlock the QR Dashboard.</p>
            <input id="signup-pin-input" type="password" maxlength="6" inputmode="numeric" autocomplete="off"
                   style="font-size:1.4rem;letter-spacing:0.4em;text-align:center;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db;width:100%;box-sizing:border-box;" />
            <div id="signup-pin-error" style="min-height:18px;margin-top:8px;font-size:0.8rem;color:#b91c1c;"></div>
            <div style="display:flex;gap:8px;justify-content:center;margin-top:16px;">
              <button id="signup-pin-cancel" type="button" class="action-btn" style="background:#e5e7eb;color:#374151;">Cancel</button>
              <button id="signup-pin-submit" type="button" class="action-btn primary">Continue</button>
            </div>
          </div>
        `;

        document.body.appendChild(overlay);
        const input = document.getElementById('signup-pin-input');
        const errEl = document.getElementById('signup-pin-error');
        const btnSubmit = document.getElementById('signup-pin-submit');
        const btnCancel = document.getElementById('signup-pin-cancel');

        function cleanup(val) {
          overlay.remove();
          if (val === null) reject(new Error('PIN cancelled')); else resolve(val);
        }

        btnCancel.addEventListener('click', () => cleanup(null));

        function trySubmit() {
          const val = String(input.value || '').trim();
          if (!/^\d{6}$/.test(val)) {
            errEl.textContent = 'PIN must be exactly 6 digits.';
            return;
          }
          cleanup(val);
        }

        btnSubmit.addEventListener('click', trySubmit);
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); trySubmit(); }
        });

        setTimeout(() => { input.focus(); }, 50);
      });
    }

    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const announcer = document.getElementById('auth-announcer');
      const btn = document.getElementById('signup-btn');
      const username = document.getElementById('signup-username').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const role = document.getElementById('signup-role').value;

      if (!email || !password) {
        const msg = 'Please enter email and password';
        announcer.textContent = msg;
        alert(msg);
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        let pin = null;
        if (role === 'admin') {
          try {
            pin = await showAdminPinOverlay();
          } catch (_) {
            // User cancelled PIN dialog
            btn.disabled = false;
            btn.textContent = 'Sign Up';
            return;
          }
        }

        // Pass optional PIN into signup so it can be stored with the account request
        await signup(email, password, role, username, pin);

        btn.textContent = 'Submitted';
        document.getElementById('signup-password').value = '';
        announcer.textContent = 'Signup successful. Redirecting...';
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 1200);
      } catch (err) {
        console.error('Signup error:', err);
        const message = `Signup failed: ${err && (err.code || err.message) ? (err.code || err.message) : err}`;
        announcer.textContent = message;
        alert(message);
        btn.disabled = false;
        btn.textContent = 'Sign Up';
      }
    });

    // If user already signed in, redirect away from signup page
    auth.onAuthStateChanged(user => {
      if (user) {
        window.location.href = '../index.html';
      }
      updateNavVisibility && updateNavVisibility();
    });
  </script>
</body>
</html>