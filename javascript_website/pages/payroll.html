<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Payroll — HRIS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Minimal styling to fit existing site style - tweak to match your CSS */
    body { font-family: Inter, system-ui, Arial; margin: 18px; color:#111; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    h1 { margin:0; font-size:20px; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    label { font-size:13px; }
    input, select, button { padding:6px 8px; font-size:14px; border:1px solid #ddd; border-radius:6px; }
    button.primary { background:#2563eb; color:#fff; border:none; }
    .summary { display:flex; gap:12px; margin:12px 0; }
    .card { padding:12px; border-radius:8px; background:#f7f9fc; box-shadow:0 1px 0 rgba(0,0,0,0.03); min-width:150px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:8px 10px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
    th { background:#fafafa; font-weight:600; }
    .muted { color:#666; font-size:13px; }
    .small { font-size:13px; }
    .actions button { margin-right:6px; }
    .tag { padding:4px 6px; border-radius:6px; background:#e6f4ea; color:#0f5132; font-weight:600; font-size:13px; }
    .warning { color:#b45309; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.3); display:flex; align-items:center; justify-content:center; }
    .modal-card { background:#fff; padding:16px; border-radius:8px; width:720px; max-height:80vh; overflow:auto; }
    .close { float:right; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Payroll</h1>
      <div class="muted">Compute payroll from QR attendance records</div>
    </div>
    <div>
      <!-- quick nav anchors, in case you want to click to QR features -->
      <a href="generator.html" class="small">QR Dashboard</a>
      &nbsp;|&nbsp;
      <a href="scanner.html" class="small">Scanner</a>
    </div>
  </header>

  <section class="controls">
    <label>From <input id="from" type="date" /></label>
    <label>To <input id="to" type="date" /></label>

    <label>Default Rate (₱ / hr) <input id="defaultRate" type="number" step="0.01" value="100" style="width:120px" /></label>

    <label>Overtime multiplier <input id="otMult" type="number" step="0.1" value="1.25" style="width:80px" /></label>

    <button id="runBtn" class="primary">Run Payroll</button>
    <button id="exportBtn">Export CSV</button>
  </section>

  <section class="summary" id="summaryArea" style="display:none">
    <div class="card"><div class="muted">Employees</div><div id="sumEmployees" style="font-weight:700">—</div></div>
    <div class="card"><div class="muted">Total Hours</div><div id="sumHours" style="font-weight:700">—</div></div>
    <div class="card"><div class="muted">Total Payroll</div><div id="sumPayroll" style="font-weight:700">—</div></div>
  </section>

  <section>
    <table id="payrollTable" aria-live="polite">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Total hrs</th>
          <th>Regular hrs</th>
          <th>OT hrs</th>
          <th>Rate (₱/hr)</th>
          <th>Gross pay (₱)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- populated by JS -->
      </tbody>
    </table>
  </section>

  <!-- Modal: attendance details -->
  <div id="modal" style="display:none" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div><strong>Attendance details</strong> <span class="close" id="closeModal">✕</span></div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
/*
  Payroll page script
  - Fetches /api/employees and /api/events
  - Pairs in/out events (chronological) per employee
  - Calculates hours per period, regular/overtime, and gross pay
  - Exports CSV
  - Note: for production, move this calculation to the server and persist payroll runs
*/

const defaultRegHoursPerDay = 8;

function isoDateToLocal(dateStr){
  return new Date(dateStr);
}

function secondsToHours(seconds){ return seconds/3600; }
function round2(n){ return Math.round(n*100)/100; }

async function fetchJson(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('Fetch error: ' + res.status);
  return res.json();
}

// Pair events into [in,out] shifts for a given array of events (filtered for employee & range)
function pairShifts(events){
  // events assumed chronological (oldest first)
  const shifts = [];
  let pendingIn = null;
  for (const ev of events){
    if (ev.action === 'in'){
      // if there is already a pendingIn, we treat previous as unmatched and replace
      if (pendingIn){
        // push unmatched as start-only (end=null)
        shifts.push({ in: pendingIn.time, out: null });
      }
      pendingIn = ev;
    } else if (ev.action === 'out'){
      if (pendingIn){
        shifts.push({ in: pendingIn.time, out: ev.time });
        pendingIn = null;
      } else {
        // out without in -> push out-only as unmatched
        shifts.push({ in: null, out: ev.time });
      }
    }
  }
  if (pendingIn){
    shifts.push({ in: pendingIn.time, out: null });
  }
  return shifts;
}

// Sum hours for a set of shifts. returns seconds
function sumShiftSeconds(shifts, fromDate, toDate){
  let totalSeconds = 0;
  for (const s of shifts){
    if (!s.in || !s.out) {
      // skip unmatched for payroll; could assume end-of-day or request correction
      continue;
    }
    const inT = new Date(s.in).getTime();
    const outT = new Date(s.out).getTime();
    // clamp to payroll period
    const startClamp = Math.max(inT, fromDate.getTime());
    const endClamp = Math.min(outT, toDate.getTime()+24*3600*1000 -1);
    if (endClamp > startClamp) totalSeconds += (endClamp - startClamp)/1000;
  }
  return totalSeconds;
}

// For daily overtime split we can compute per-day hours array (simple approach)
function computeDailyBreakdown(shifts, fromDate, toDate){
  // Build map: day (YYYY-MM-DD) -> seconds
  const daySeconds = {};
  const start = new Date(fromDate);
  const end = new Date(toDate);
  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
    const key = d.toISOString().slice(0,10);
    daySeconds[key] = 0;
  }
  for (const s of shifts){
    if (!s.in || !s.out) continue;
    let curIn = new Date(s.in);
    let curOut = new Date(s.out);
    // clamp
    if (curOut < fromDate || curIn > new Date(toDate.getTime()+24*3600*1000-1)) continue;
    curIn = new Date(Math.max(curIn.getTime(), fromDate.getTime()));
    curOut = new Date(Math.min(curOut.getTime(), toDate.getTime()+24*3600*1000-1));
    // split across days
    let cursor = new Date(curIn);
    while (cursor < curOut){
      const dayKey = cursor.toISOString().slice(0,10);
      const dayEnd = new Date(cursor); dayEnd.setHours(23,59,59,999);
      const segEnd = new Date(Math.min(dayEnd.getTime(), curOut.getTime()));
      const secs = (segEnd.getTime() - cursor.getTime())/1000;
      if (daySeconds[dayKey] === undefined) daySeconds[dayKey] = 0;
      daySeconds[dayKey] += secs;
      cursor = new Date(segEnd.getTime()+1);
    }
  }
  return daySeconds;
}

function secondsToHrsMins(seconds){
  const h = Math.floor(seconds/3600);
  const m = Math.round((seconds%3600)/60);
  return `${h}h ${m}m`;
}

function downloadCSV(filename, csvContent){
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('runBtn').addEventListener('click', runPayroll);
document.getElementById('exportBtn').addEventListener('click', exportCSV);
document.getElementById('closeModal').addEventListener('click', ()=> document.getElementById('modal').style.display='none');

async function runPayroll(){
  try {
    // read inputs
    const fromStr = document.getElementById('from').value;
    const toStr   = document.getElementById('to').value;
    if (!fromStr || !toStr){ alert('Choose date range'); return; }
    const fromDate = new Date(fromStr + 'T00:00:00');
    const toDate = new Date(toStr + 'T00:00:00');
    const defaultRate = parseFloat(document.getElementById('defaultRate').value) || 0;
    const otMult = parseFloat(document.getElementById('otMult').value) || 1.25;

    // fetch data
    const [employees, events] = await Promise.all([ fetchJson('/api/employees'), fetchJson('/api/events') ]);
    // prepare events map per employee, sorted ascending
    const eventsByEmp = {};
    for (const ev of events){
      if (!eventsByEmp[ev.employeeId]) eventsByEmp[ev.employeeId] = [];
      eventsByEmp[ev.employeeId].push(ev);
    }
    for (const k of Object.keys(eventsByEmp)) {
      eventsByEmp[k].sort((a,b)=> new Date(a.time) - new Date(b.time));
    }

    // Build payroll rows
    const rows = [];
    let totalHours = 0;
    let totalPayroll = 0;
    for (const emp of employees){
      const evs = eventsByEmp[emp.id] || [];
      // filter to period (we still keep context but pair shifts using full event list then clamp)
      const shifts = pairShifts(evs);
      const totalSeconds = sumShiftSeconds(shifts, fromDate, toDate);
      const daySeconds = computeDailyBreakdown(shifts, fromDate, toDate);
      // compute regular & overtime per day
      let regSeconds = 0, otSeconds = 0;
      for (const day in daySeconds){
        const secs = daySeconds[day];
        const reg = Math.min(secs, defaultRegHoursPerDay*3600);
        regSeconds += reg;
        otSeconds += Math.max(0, secs - defaultRegHoursPerDay*3600);
      }
      // convert to hours
      const totalHrs = round2(secondsToHours(totalSeconds));
      const regHrs = round2(secondsToHours(regSeconds));
      const otHrs = round2(secondsToHours(otSeconds));
      const rate = emp.rate ? parseFloat(emp.rate) : defaultRate;
      const gross = round2(regHrs * rate + otHrs * rate * otMult);

      rows.push({
        empId: emp.id,
        name: emp.name,
        totalHrs, regHrs, otHrs, rate, gross,
        shifts, events: evs
      });
      totalHours += totalHrs;
      totalPayroll += gross;
    }

    // update UI
    document.getElementById('summaryArea').style.display = 'flex';
    document.getElementById('sumEmployees').innerText = rows.length;
    document.getElementById('sumHours').innerText = round2(totalHours) + ' hrs';
    document.getElementById('sumPayroll').innerText = '₱ ' + round2(totalPayroll);

    const tbody = document.querySelector('#payrollTable tbody');
    tbody.innerHTML = '';
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${r.name}</strong><div class="muted">${r.empId}</div></td>
        <td>${r.totalHrs}</td>
        <td>${r.regHrs}</td>
        <td>${r.otHrs}</td>
        <td>₱ ${r.rate}</td>
        <td>₱ ${r.gross}</td>
        <td class="actions">
          <button data-id="${r.empId}" class="viewBtn small">View</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    // wire view buttons
    document.querySelectorAll('.viewBtn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        const row = rows.find(x=>x.empId===id);
        showModalFor(row, fromDate, toDate);
      });
    });

    // stash last run for export
    window.__lastPayrollRows = rows;
    window.__lastPayrollMeta = { from: fromDate, to: toDate, otMult, defaultRate };

  } catch (err){
    alert('Run failed: ' + err.message);
    console.error(err);
  }
}

function showModalFor(row, fromDate, toDate){
  const modal = document.getElementById('modal');
  const body = document.getElementById('modalBody');
  let html = `<div><strong>${row.name}</strong> (${row.empId})</div>`;
  html += `<div class="muted">Period: ${fromDate.toISOString().slice(0,10)} — ${toDate.toISOString().slice(0,10)}</div>`;
  html += '<hr />';
  html += '<div><strong>Shifts (paired):</strong></div>';
  html += '<table style="width:100%"><thead><tr><th>In</th><th>Out</th><th>Duration</th></tr></thead><tbody>';
  for (const s of row.shifts){
    const inT = s.in ? new Date(s.in).toLocaleString() : '<span class="warning">— missing in</span>';
    const outT = s.out ? new Date(s.out).toLocaleString() : '<span class="warning">— missing out</span>';
    let dur = '—';
    if (s.in && s.out){
      dur = secondsToHrsMins((new Date(s.out) - new Date(s.in))/1000);
    }
    html += `<tr><td>${inT}</td><td>${outT}</td><td>${dur}</td></tr>`;
  }
  html += '</tbody></table>';
  html += '<hr /><div><strong>Raw events</strong></div><ul>';
  for (const ev of row.events){
    html += `<li>${new Date(ev.time).toLocaleString()} — ${ev.action}</li>`;
  }
  html += '</ul>';
  html += `<div style="margin-top:10px;"><button id="closeModalBtn">Close</button></div>`;
  body.innerHTML = html;
  modal.style.display = 'flex';
  document.getElementById('closeModalBtn').onclick = ()=> modal.style.display='none';
}

function exportCSV(){
  const rows = window.__lastPayrollRows;
  const meta = window.__lastPayrollMeta;
  if (!rows || !meta) { alert('Run payroll first'); return; }
  let csv = 'Employee ID,Name,Total Hours,Regular Hours,OT Hours,Rate,Gross\\n';
  for (const r of rows){
    csv += `${r.empId},"${r.name}",${r.totalHrs},${r.regHrs},${r.otHrs},${r.rate},${r.gross}\\n`;
  }
  downloadCSV(`payroll_${meta.from.toISOString().slice(0,10)}_${meta.to.toISOString().slice(0,10)}.csv`, csv);
}

// set default period to last calendar month
(function initDefaults(){
  const today = new Date();
  const to = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const from = new Date(to.getFullYear(), to.getMonth(), 1);
  document.getElementById('from').value = from.toISOString().slice(0,10);
  document.getElementById('to').value = to.toISOString().slice(0,10);
})();
</script>
</body>
</html>
