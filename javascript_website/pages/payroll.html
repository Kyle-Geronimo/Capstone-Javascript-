<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Payroll — HRIS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="../image/logo/HTLogo.png">
  <link rel="stylesheet" href="../css/styles.css">
  <!-- Add UI improvements after base styles -->
  <link rel="stylesheet" href="../css/payroll-enhancements.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>HotelLink</h1>
      <nav>
        <a href="../index2.html" class="nav-btn">Home</a>
        <a href="chatbot.html" class="nav-btn restricted">Chatbot Data</a>
        <a href="admin.html" class="nav-btn restricted admin-only">Admin</a>
        <a href="payroll.html" class="nav-btn restricted admin-only">Payroll</a>
        <a href="profile.html" class="nav-btn restricted">Profile</a>
      </nav>
    </div>
  </header>

  <main class="container page">
    <h2>Payroll</h2>

    <div class="payroll-actions">
      <div class="group">
        <label>Period start: <input type="date" id="periodStart"></label>
        <label>Period end: <input type="date" id="periodEnd"></label>

        <button id="loadUsersBtn" class="action-btn">Reload Table</button>

        <label class="action-btn file-import-label">
          Import tabulation
          <input id="importXlsx" type="file" accept=".xlsx,.xls" />
        </label>
        <span id="importStatus" class="sss-status"></span>
        <button id="reloadSssTableBtn" class="action-btn ml-8">Reload SSS Table</button>

        <div id="sssModalBackdrop" class="sss-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="sssModalTitle">
          <div class="sss-modal" role="document">
            <div class="sss-modal-header">
              <div class="sss-modal-title" id="sssModalTitle">Import preview — SSS tabulation</div>
              <div class="controls sss-controls">
                <button id="sssModalClose" class="sss-close" title="Close (Esc)">✕</button>
              </div>
            </div>

            <div class="sss-modal-body" id="sssModalBody">
              <div id="sssPreviewInfo"></div>
              <div id="sssPreviewTableContainer"></div>
              <div id="sssPreviewWarn"></div>
            </div>

            <div class="sss-modal-footer">
              <button id="sssCancelBtn" class="sss-btn secondary">Cancel</button>
              <button id="sssConfirmBtn" class="sss-btn">Confirm & Save</button>
            </div>
          </div>
        </div>
      </div>

      <div class="group">
        <button id="calculateBtn" class="action-btn">Calculate</button>
      </div>

      <div class="action-row">
        <a href="qr-dashboard.html" class="action-btn">QR Dashboard</a>
      </div>

      <div class="group ml-auto">
        <button id="saveRunBtn" class="action-btn primary">Save Payroll Run</button>
        <button id="exportCsvBtn" class="action-btn">Export CSV</button>
        <span class="small-note ml-8">Rows: <strong id="rowsCount">0</strong></span>
      </div>
    </div>

    <!-- Holiday pickers: centered and fixed width -->
    <div id="holidayPickers" class="holiday-pickers">
      <div class="holiday-card">
        <h3>Regular Holidays</h3>
        <div id="regHolidayCalendar" class="small-calendar"></div>
        <div class="calendar-actions">
          <button id="regPrevMonth">◀</button>
          <span id="regMonthLabel"></span>
          <button id="regNextMonth">▶</button>
          <button id="clearRegHolidays" title="Clear all regular holidays">Clear</button>
        </div>
        <div class="calendar-hint">Click a date to toggle. Picked days will be used as Regular Holidays.</div>
      </div>

      <div class="holiday-card">
        <h3>Special Holidays</h3>
        <div id="specHolidayCalendar" class="small-calendar"></div>
        <div class="calendar-actions">
          <button id="specPrevMonth">◀</button>
          <span id="specMonthLabel"></span>
          <button id="specNextMonth">▶</button>
          <button id="clearSpecHolidays" title="Clear all special holidays">Clear</button>
        </div>
        <div class="calendar-hint">Click a date to toggle. Picked days will be used as Special Holidays.</div>
      </div>
    </div>

    <div id="holidayStatus"></div>

    <div id="status" class="small-note" aria-live="polite"></div>

    <div class="table-wrap">
      <table class="data-table payroll-table" id="payrollTable" role="grid" aria-label="Payroll table">
        <thead>
          <tr>
            <th>#</th>
            <th>Username</th>
            <th>Rate</th>
            <th>Days</th>
            <th>Hours (auto)</th>
            <th>ND hrs</th>
            <th>ND-on-OT hrs</th>
            <th>OT hrs</th>
            <th>RegHol hrs</th>
            <th>SpecHol hrs</th>
            <th>SSS (emp)</th>
            <th>PhilHealth (emp)</th>
            <th>Pag-IBIG (emp)</th>
            <th>ST. PETER</th>
            <th>SSS Salary Loan</th>
            <th>SSS Calamity Loan</th>
            <th>HDMF Salary Loan</th>
            <th>HDMF Calamity Loan</th>
            <th>Cash Advance / Credit</th>
            <th>UT / LATE (hrs)</th>
            <th>UT / LATE AMOUNT</th>
            <th>Gross (auto)</th>
            <th>Deductions (total auto)</th>
            <th>Net (auto)</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="payrollBody"></tbody>
      </table>
    </div>

    <!-- Payroll loading overlay -->
    <div id="payrollLoadingOverlay" class="hidden" aria-hidden="true">
      <div class="payroll-loading-backdrop"></div>
      <div class="payroll-loading-content" role="status" aria-live="polite">
        <div class="spinner"></div>
        <div id="payrollLoadingText">Processing payroll…</div>
      </div>
    </div>

  </main>

  <footer>
    <div class="container">
      <p style="text-align: center;">&copy; 2025 D’ Mariners Inn Hotel. All rights reserved.</p>
    </div>
  </footer>

  <script type="module" src="../js/firebase-config.js"></script>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script type="module" src="../js/payroll.js"></script>

  <!-- Include the small UI enhancement script AFTER payroll.js (rebind helper exposed by payroll-ui.js) -->
  <script type="module" src="../js/payroll-ui.js"></script>

  <script type="module">
    import { auth, getUserRole } from '../js/firebase-config.js';
    import { updateNavVisibility, highlightActiveNavBtn } from '../js/nav-control.js';

    // ensure nav visibility helpers run
    updateNavVisibility();
    highlightActiveNavBtn();

    auth.onAuthStateChanged(async (user) => {
      updateNavVisibility();
      highlightActiveNavBtn();

      if (!user) {
        // Not signed in, send to login
        window.location.href = 'login.html';
        return;
      }

      const role = await getUserRole(user.uid);
      if (role !== 'admin') {
        // Block employees from payroll dashboard
        window.location.href = 'profile.html';
        return;
      }

      // if payroll.js re-renders the table after async load, rebind UI hooks
      // (payroll.js already exposes window.rebindPayrollUI in payroll-ui.js)
      // call it once page is ready
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof window.rebindPayrollUI === 'function') window.rebindPayrollUI();
        // also call after a short delay to catch async renders
        setTimeout(() => { if (typeof window.rebindPayrollUI === 'function') window.rebindPayrollUI(); }, 800);
      });
    });
  </script>

</body>
</html>