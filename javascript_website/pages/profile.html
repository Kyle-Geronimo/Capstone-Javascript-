<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HotelLink - Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script type="module" src="../js/auth.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>HotelLink</h1>
      <nav>
        <a href="../index.html" class="nav-btn">Home</a>
        <a href="chatbot.html" class="nav-btn restricted">Chatbot Data</a>
        <a href="admin.html" class="nav-btn restricted admin-only">Admin</a>
        <a href="payroll.html" class="nav-btn restricted admin-only">Payroll</a>
        <a href="profile.html" class="nav-btn restricted">Profile</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="page">
      <div class="content-container profile-layout">
        <div class="profile-section">
          <div id="profile-info"></div>
        </div>
        
        <!-- QR Code Section -->
        <div class="qr-section">
          <div class="profile-card">
            <h2>My QR Code</h2>
            <div id="userQrContainer" style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
              <div id="userQrCode" style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #e8ecf5;">
                <p style="text-align: center; color: #666; margin: 0;">Loading QR code...</p>
              </div>
              <button id="downloadUserQr" class="action-btn" style="display: none;">Download QR</button>
              <button id="printUserQr" class="action-btn" style="display: none;">Print QR</button>
            </div>
          </div>
        </div>
        
        <div class="payroll-section">
          <div id="payroll-info">
          <div class="profile-card">
            <h2>My Payroll Information</h2>
            <div class="payroll-filters">
              <div class="form-group">
                <label for="payrollMonth">Month</label>
                <select id="payrollMonth" class="form-control"></select>
              </div>
              <div class="form-group">
                <label for="payrollPeriod">Period</label>
                <select id="payrollPeriod" class="form-control">
                  <option value="1-15">1 - 15</option>
                  <option value="16-end">16 - end</option>
                </select>
              </div>
              <button id="loadPayroll" class="action-btn primary">View Payroll</button>
            </div>
            <div id="payrollDetails">
              <div class="payroll-summary">
                <h3>Payroll Summary</h3>
                <table class="data-table">
                  <tbody>
                    <tr>
                      <td>Basic Pay:</td>
                      <td id="basicPay">-</td>
                    </tr>
                    <tr>
                      <td>Morning Shift Days:</td>
                      <td id="morningDays">-</td>
                    </tr>
                    <tr>
                      <td>Mid Shift Days:</td>
                      <td id="midDays">-</td>
                    </tr>
                    <tr>
                      <td>Night Shift Days:</td>
                      <td id="nightDays">-</td>
                    </tr>
                    <tr>
                      <td>Overtime Hours:</td>
                      <td id="otHours">-</td>
                    </tr>
                    <tr>
                      <td>Overtime Amount:</td>
                      <td id="otAmount">-</td>
                    </tr>
                    <tr>
                      <td>Regular Holiday Hours:</td>
                      <td id="regHolHours">-</td>
                    </tr>
                    <tr>
                      <td>Regular Holiday Amount:</td>
                      <td id="regHolAmount">-</td>
                    </tr>
                  </tbody>
                </table>

                <h3>Deductions</h3>
                <table class="data-table">
                  <tbody>
                    <tr>
                      <td>SSS Contribution:</td>
                      <td id="sssEmployee">-</td>
                    </tr>
                    <tr>
                      <td>PhilHealth Contribution:</td>
                      <td id="philhealthEmployee">-</td>
                    </tr>
                    <tr>
                      <td>Pagibig Contribution:</td>
                      <td id="pagibigEmployee">-</td>
                    </tr>
                    <tr>
                      <td>Total Deductions:</td>
                      <td id="totalDeductions">-</td>
                    </tr>
                  </tbody>
                </table>

                <h3>Net Pay</h3>
                <table class="data-table">
                  <tbody>
                    <tr>
                      <td>Gross Pay:</td>
                      <td id="grossPay">-</td>
                    </tr>
                    <tr>
                      <td>Net Pay:</td>
                      <td id="netPay">-</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 D' Mariners Inn Hotel. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
    import { auth, getUserRole } from '../js/firebase-config.js';
    import { loadProfile, loadUserQR, downloadUserQR, printUserQR } from '../js/profile.js';
    import { updateNavVisibility, highlightActiveNavBtn } from '../js/nav-control.js';

    const container = document.getElementById('profile-info');
    container.innerHTML = '<div class="profile-card"><em>Loading profile...</em></div>';
    
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = '../pages/login.html';
        return;
      }

      // Get the profile ID from URL if any
      const urlParams = new URLSearchParams(window.location.search);
      const profileId = urlParams.get('uid');

      // Only allow viewing own profile unless admin
      const role = await getUserRole(user.uid);
      if (profileId && profileId !== user.uid && role !== 'admin') {
        window.location.href = '../index.html';
        return;
      }

      // Load the appropriate profile
      try {
        await loadProfile(profileId || user.uid);
        
        // Load user's QR code
        await loadUserQR(user.uid);
        
        // Setup QR download/print buttons
        document.getElementById('downloadUserQr').addEventListener('click', downloadUserQR);
        document.getElementById('printUserQr').addEventListener('click', printUserQR);
        await updateNavVisibility();
        highlightActiveNavBtn();
      } catch (err) {
        console.error('Profile load error:', err);
        container.innerHTML = `<div class="profile-card"><em>Error loading profile: ${err.message}</em></div>`;
      }
    });

    // Update nav immediately and on auth state changes
    updateNavVisibility();
    highlightActiveNavBtn();
    auth.onAuthStateChanged(() => {
      updateNavVisibility();
      highlightActiveNavBtn();
    });
  </script>

  <!-- Static Edit Profile Modal (hidden by default) -->
  <div id="profile-edit-root" class="hidden">
    <div class="profile-edit-backdrop" id="profile-edit-backdrop" aria-hidden="true"></div>
    <div class="profile-edit-modal" role="dialog" aria-modal="true" aria-labelledby="profile-edit-title" hidden>
      <form class="profile-edit-form" id="profile-edit-form">
        <h3 id="profile-edit-title">Edit Profile</h3>
        <div class="form-group">
          <label class="form-label" for="edit-name">Name</label>
          <input class="form-control" type="text" id="edit-name" name="edit-name" placeholder="Your name">
        </div>

        <div class="profile-photo-section">
          <div class="current-photo" id="current-photo-area">
            <p id="no-photo-text">No profile picture set</p>
          </div>
          <label class="file-upload-btn" for="photo-url">
            <span>Enter Image URL</span>
            <input class="form-control" type="url" id="photo-url" name="photo-url" placeholder="Enter image URL">
          </label>
          <button type="button" class="action-btn remove-photo hidden" id="remove-photo">Remove Profile Picture</button>
        </div>

        <div class="modal-actions">
          <button type="button" class="action-btn secondary" id="cancel-edit">Cancel</button>
          <button type="submit" class="action-btn primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializePayrollSystem, computeForPeriod } from '../js/payroll.js';
    import { firebaseConfig } from '../js/firebase-config.js';
    import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js';

    // Initialize payroll system
    await initializePayrollSystem(firebaseConfig);
    const db = getFirestore();

    // Populate month select
    const monthSelect = document.getElementById('payrollMonth');
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                   'July', 'August', 'September', 'October', 'November', 'December'];
    months.forEach((month, index) => {
      const option = document.createElement('option');
      option.value = index + 1;
      option.textContent = month;
      monthSelect.appendChild(option);
    });
    monthSelect.value = new Date().getMonth() + 1;

    // Handle payroll view button
    document.getElementById('loadPayroll').addEventListener('click', async () => {
      const month = document.getElementById('payrollMonth').value;
      const period = document.getElementById('payrollPeriod').value;
      
      try {
        // Get current user's data only
        const user = auth.currentUser;
        if (!user) return;

        // Get user's employment details
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) return;
        const userData = userDoc.data();

        // Get attendance records for the user
        const attendanceRef = collection(db, 'attendance');
        const attendanceQuery = query(attendanceRef, where('userId', '==', user.uid));
        const attendanceSnapshot = await getDocs(attendanceQuery);
        const dtrRows = attendanceSnapshot.docs.map(doc => doc.data());

        // Compute payroll for just this user
        const payrollRows = computeForPeriod([userData], dtrRows, month, period);
        
        if (payrollRows && payrollRows.length > 0) {
          const payroll = payrollRows[0];
          
          // Update UI with payroll details
          document.getElementById('basicPay').textContent = formatCurrency(payroll.basic);
          document.getElementById('morningDays').textContent = payroll.morningShiftDays;
          document.getElementById('midDays').textContent = payroll.midShiftDays;
          document.getElementById('nightDays').textContent = payroll.nightShiftDays;
          document.getElementById('otHours').textContent = payroll.otHours;
          document.getElementById('otAmount').textContent = formatCurrency(payroll.otAmount);
          document.getElementById('regHolHours').textContent = payroll.regHolHours;
          document.getElementById('regHolAmount').textContent = formatCurrency(payroll.regHolAmount);
          document.getElementById('sssEmployee').textContent = formatCurrency(payroll.sssEmployee);
          document.getElementById('philhealthEmployee').textContent = formatCurrency(payroll.philhealthEmployee);
          document.getElementById('pagibigEmployee').textContent = formatCurrency(payroll.pagibigEmployee);
          document.getElementById('totalDeductions').textContent = formatCurrency(payroll.totalDeductions);
          document.getElementById('grossPay').textContent = formatCurrency(payroll.gross);
          document.getElementById('netPay').textContent = formatCurrency(payroll.net);
        } else {
          // No payroll data found
          const fields = ['basicPay', 'morningDays', 'midDays', 'nightDays', 'otHours', 
                         'otAmount', 'regHolHours', 'regHolAmount', 'sssEmployee', 
                         'philhealthEmployee', 'pagibigEmployee', 'totalDeductions', 
                         'grossPay', 'netPay'];
          fields.forEach(field => {
            document.getElementById(field).textContent = '-';
          });
        }
      } catch (error) {
        console.error('Error loading payroll:', error);
        alert('Error loading payroll information. Please try again.');
      }
    });

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-PH', {
        style: 'currency',
        currency: 'PHP'
      }).format(amount);
    }
  </script>
</body>
</html>
