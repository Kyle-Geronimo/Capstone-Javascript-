<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HotelLink - Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../image/logo/HTLogo.png">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>window.API_BASE = 'https://mariners-hotellink.com';</script>
  <script type="module" src="../js/auth.js"></script>
  <script type="module" src="../js/payroll.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>HotelLink</h1>
      <nav>
        <a href="../index2.html" class="nav-btn">Home</a>
        <a href="chatbot.html" class="nav-btn restricted">Chatbot Data</a>
        <a href="admin.html" class="nav-btn restricted admin-only">Admin</a>
        <a href="payroll.html" class="nav-btn restricted admin-only">Payroll</a>
        <a href="profile.html" class="nav-btn restricted">Profile</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="page">
      <div class="content-container profile-layout">
        <!-- Profile Section -->
        <div class="profile-section">
          <div id="profile-info"></div>
        </div>
        
        <!-- QR Code Section -->
        <div class="qr-section">
          <div class="profile-card">
            <h2>My QR Code</h2>
            <div id="userQrContainer" style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
              <div id="userQrCode" style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #e8ecf5;">
                <p style="text-align: center; color: #666; margin: 0;">Loading QR code...</p>
              </div>
              <button id="downloadUserQr" class="action-btn" style="display: none;">Download QR</button>
              <button id="printUserQr" class="action-btn" style="display: none;">Print QR</button>
            </div>
          </div>
        </div>
        <!-- Payroll Section -->
        <!-- ===== REPLACE existing payroll area with this payroll display (profile.html) ===== -->
        <section id="payroll-info" class="profile-section">
          <h2>Payroll</h2>

          <!-- Banner for the shown payroll run (created by JS when approved) -->

          <!-- Visible payroll card -->
          <div id="payrollDetails" class="payroll-card">
            <div class="payroll-row">
              <div class="label">Basic Pay</div>
              <div id="basicPay" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">Overtime Amount</div>
              <div id="otAmount" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">Gross Pay</div>
              <div id="grossPay" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">Net Pay</div>
              <div id="netPay" class="value">-</div>
            </div>

            <hr/>

            <div class="payroll-row">
              <div class="label">SSS (Employee)</div>
              <div id="sssEmployee" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">PhilHealth (Employee)</div>
              <div id="philhealthEmployee" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">Pag-IBIG (Employee)</div>
              <div id="pagibigEmployee" class="value">-</div>
            </div>

            <hr/>

            <div class="payroll-row">
              <div class="label">Morning Shift Days</div>
              <div id="morningDays" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">Mid Shift Days</div>
              <div id="midDays" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">Night Shift Days</div>
              <div id="nightDays" class="value">-</div>
            </div>

            <div class="payroll-row">
              <div class="label">OT Hours</div>
              <div id="otHours" class="value">-</div>
            </div>

            <div class="payroll-actions">
              <!-- This button triggers the request flow in the JS -->
              <button id="loadPayroll" class="btn primary">Request Payroll View</button>
              <small class="hint">Request a view of your most recent saved payroll run. An admin will approve or deny your request.</small>
            </div>
          </div>
        </section>
        <!-- ===== end payroll area ===== -->
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 D' Mariners Inn Hotel. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
    import { auth, getUserRole } from '../js/firebase-config.js';
    import { loadProfile, loadUserQR, downloadUserQR, printUserQR } from '../js/profile.js';
    import { updateNavVisibility, highlightActiveNavBtn } from '../js/nav-control.js';

    const container = document.getElementById('profile-info');
    container.innerHTML = '<div class="profile-card"><em>Loading profile...</em></div>';
    
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = '../pages/login.html';
        return;
      }


      const urlParams = new URLSearchParams(window.location.search);
      const profileId = urlParams.get('uid');


      const role = await getUserRole(user.uid);
      if (profileId && profileId !== user.uid && role !== 'admin') {
        window.location.href = '../index.html';
        return;
      }


      try {
        await loadProfile(profileId || user.uid);
        

        await loadUserQR(user.uid);
        

        document.getElementById('downloadUserQr').addEventListener('click', downloadUserQR);
        document.getElementById('printUserQr').addEventListener('click', printUserQR);
        await updateNavVisibility();
        highlightActiveNavBtn();
      } catch (err) {
        console.error('Profile load error:', err);
        container.innerHTML = `<div class="profile-card"><em>Error loading profile: ${err.message}</em></div>`;
      }
    });


    updateNavVisibility();
    highlightActiveNavBtn();
    auth.onAuthStateChanged(() => {
      updateNavVisibility();
      highlightActiveNavBtn();
    });
  </script>

  <!-- Static Edit Profile Modal (hidden by default) -->
  <div id="profile-edit-root" class="hidden">
    <div class="profile-edit-backdrop" id="profile-edit-backdrop" aria-hidden="true"></div>
    <div class="profile-edit-modal" role="dialog" aria-modal="true" aria-labelledby="profile-edit-title" hidden>
      <form class="profile-edit-form" id="profile-edit-form">
        <h3 id="profile-edit-title">Edit Profile</h3>
        <div class="form-group">
          <label class="form-label" for="edit-name">Name</label>
          <input class="form-control" type="text" id="edit-name" name="edit-name" placeholder="Your name">
        </div>

        <div class="profile-photo-section">
          <div class="current-photo" id="current-photo-area">
            <p id="no-photo-text">No profile picture set</p>
          </div>
          <label class="file-upload-btn" for="photo-url">
            <span>Enter Image URL</span>
            <input class="form-control" type="url" id="photo-url" name="photo-url" placeholder="Enter image URL">
          </label>
          <button type="button" class="action-btn remove-photo hidden" id="remove-photo">Remove Profile Picture</button>
        </div>

        <div class="modal-actions">
          <button type="button" class="action-btn secondary" id="cancel-edit">Cancel</button>
          <button type="submit" class="action-btn primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    // Wait-for-global helper (polls for a global variable to exist)
    function waitForGlobal(name, timeout = 5000, interval = 100) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function poll() {
          if (window[name]) return resolve(window[name]);
          if (Date.now() - start >= timeout) return reject(new Error(`${name} not available after ${timeout}ms`));
          setTimeout(poll, interval);
        })();
      });
    }

    (async () => {
      try {
        // Wait for firebase globals and payroll helper to be registered by your other scripts
        const auth = await waitForGlobal('auth', 10000).catch(() => null);
        const db = await waitForGlobal('db', 10000).catch(() => null);
        // fetchMostRecentPayrollRun should be globally available from payroll.js (profile page loads it)
        const fetchMostRecentPayrollRun = await waitForGlobal('fetchMostRecentPayrollRun', 10000).catch(() => null);

        if (!auth || !db) {
          console.error('Firebase auth/db globals not ready on profile page. Payroll features disabled.');
          return;
        }
        if (!fetchMostRecentPayrollRun) {
          console.warn('fetchMostRecentPayrollRun not found. Payroll view will still request approval but cannot auto-load runs.');
        }

        // Import Firestore helpers (we still import getDocs because profile uses it)
        const { addDoc, collection, query, where, onSnapshot, serverTimestamp, doc, getDoc, getDocs } =
          await import('https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js');

        // Role-based guard: only admins can see payroll on profile
        try {
          const currentUserForRole = auth.currentUser;
          if (currentUserForRole) {
            const uRefRole = doc(db, 'users', currentUserForRole.uid);
            const uSnapRole = await getDoc(uRefRole);
            const uDataRole = uSnapRole.exists() ? uSnapRole.data() : {};
            if (uDataRole && uDataRole.role && uDataRole.role !== 'admin') {
              const payrollSection = document.getElementById('payroll-info');
              if (payrollSection) payrollSection.style.display = 'none';
              // Do not initialize any payroll listeners or requests for non-admins
              return;
            }
          }
        } catch (roleErr) {
          console.error('Error checking role for payroll visibility on profile:', roleErr);
        }

        // Elements
        const requestBtn = document.getElementById('loadPayroll');
        if (!requestBtn) {
          console.warn('Payroll request button #loadPayroll not found');
          return;
        }
        requestBtn.textContent = 'Request Payroll View';

        // If this user already has payrollViewAllowed === true, auto-load their latest payroll run
        try {
          const currentUser = auth.currentUser;
          if (currentUser && fetchMostRecentPayrollRun) {
            const uRef = doc(db, 'users', currentUser.uid);
            const uSnap = await getDoc(uRef);
            const uData = uSnap.exists() ? uSnap.data() : {};
            if (uData && uData.payrollViewAllowed) {
              // Enforce 24-hour visibility window based on payrollViewAllowedAt
              const allowedAt = uData.payrollViewAllowedAt || null;
              let withinWindow = false;
              if (allowedAt) {
                let ts = null;
                try {
                  ts = typeof allowedAt.toMillis === 'function'
                    ? allowedAt.toMillis()
                    : new Date(allowedAt).getTime();
                } catch (_) {
                  ts = null;
                }
                if (ts && Number.isFinite(ts)) {
                  const ageMs = Date.now() - ts;
                  const windowMs = 24 * 60 * 60 * 1000; // 24 hours
                  withinWindow = ageMs >= 0 && ageMs <= windowMs;
                }
              }

              if (withinWindow) {
                try {
                  const { ratesMap, runMeta, linesMap } = await fetchMostRecentPayrollRun();
                  await renderPayrollForUser(currentUser.uid, linesMap, runMeta);
                } catch (autoErr) {
                  console.error('Auto-load payroll failed:', autoErr);
                }
              } else {
                console.log('payrollViewAllowed flag exists but is outside the 24-hour window; not auto-loading payroll.');
              }
            }
          }
        } catch (flagErr) {
          console.error('Error checking payrollViewAllowed flag:', flagErr);
        }

        // Click handler: create request doc
        requestBtn.addEventListener('click', async () => {
          try {
            const user = auth.currentUser;
            if (!user) { alert('Please sign in to request payroll view.'); return; }

            const uDocRef = doc(db, 'users', user.uid);
            const uSnap = await getDoc(uDocRef);
            const u = uSnap.exists() ? uSnap.data() : {};

            // avoid duplicate pending
            const q = query(collection(db, 'payrollViewRequests'), where('userId', '==', user.uid), where('status', '==', 'pending'));
            const snap = await getDocs(q);
            if (!snap.empty) {
              alert('You already have a pending payroll view request. An admin will review it shortly.');
              return;
            }

            const payload = {
              userId: user.uid,
              username: u.username || u.email || '',
              department: u.department || '',
              status: 'pending',
              createdAt: serverTimestamp()
            };

            await addDoc(collection(db, 'payrollViewRequests'), payload);
            alert('Payroll view request submitted. An admin will review it.');
          } catch (err) {
            console.error('Failed to submit payroll request', err);
            alert('Failed to submit payroll request: ' + (err.message || err));
          }
        });

        // Listen for this user's payroll request changes and show payroll when approved.
        (function listenForMyPayrollRequestChanges() {
          auth.onAuthStateChanged(user => {
            if (!user) return;
            const reqQ = query(collection(db, 'payrollViewRequests'), where('userId', '==', user.uid));
            const unsub = onSnapshot(reqQ, async snap => {
              if (snap.empty) return;
              const docs = snap.docs.sort((a,b)=>{
                const A = a.data().createdAt ? a.data().createdAt.toMillis() : 0;
                const B = b.data().createdAt ? b.data().createdAt.toMillis() : 0;
                return B - A;
              });
              const req = docs[0].data();
              if (req.status === 'approved') {
                try {
                  if (!fetchMostRecentPayrollRun) {
                    alert('Request approved but payroll loader is not available on this page.');
                    return;
                  }
                  const { ratesMap, runMeta, linesMap } = await fetchMostRecentPayrollRun();
                  await renderPayrollForUser(user.uid, linesMap, runMeta);
                } catch (e) {
                  console.error('Error loading saved payroll run after approval', e);
                  alert('Failed to load saved payroll run.');
                }
              } else if (req.status === 'denied') {
                alert('Your payroll view request was denied by an administrator.');
              } else {
                // pending - no UI change
              }
            }, err => {
              console.error('payrollViewRequests listener failed', err);
            });

            window.addEventListener('beforeunload', () => { if (typeof unsub === 'function') unsub(); });
          });
        })();

        // Helpers
        async function renderPayrollForUser(userId, linesMap, runMeta) {
          if (!linesMap) return;
          const hasLine =
            typeof linesMap.has === 'function'
              ? linesMap.has(userId)
              : (linesMap[userId] !== undefined);
          const line = hasLine
            ? (typeof linesMap.get === 'function' ? linesMap.get(userId) : linesMap[userId])
            : null;

          if (!line) {
            alert('There is no saved payroll line for you in the most recent run.');
            return;
          }

          const basicFromGross = (line.grossPay !== undefined) ? line.grossPay : undefined;
          const gross = (line.grossPay !== undefined) ? line.grossPay : line.gross;
          const net = (line.netPay !== undefined) ? line.netPay : line.net;

          if (basicFromGross !== undefined) document.getElementById('basicPay').textContent = formatCurrency(basicFromGross);

          // Derive OT amount if not explicitly stored: ratePerDay / 8 * otHours
          let otAmountVal = line.otAmount;
          if (otAmountVal === undefined && line.otHours !== undefined && line.ratePerDay !== undefined) {
            const ratePerHour = Number(line.ratePerDay) / 8;
            otAmountVal = ratePerHour * Number(line.otHours || 0);
          }
          if (otAmountVal !== undefined) document.getElementById('otAmount').textContent = formatCurrency(otAmountVal);

          if (gross !== undefined) document.getElementById('grossPay').textContent = formatCurrency(gross);
          if (net !== undefined) document.getElementById('netPay').textContent = formatCurrency(net);

          // Statutory contributions: use employee-share fields from payroll lines
          if (line.sss !== undefined) document.getElementById('sssEmployee').textContent = formatCurrency(line.sss);
          if (line.philhealth !== undefined) document.getElementById('philhealthEmployee').textContent = formatCurrency(line.philhealth);
          if (line.pagibig !== undefined) document.getElementById('pagibigEmployee').textContent = formatCurrency(line.pagibig);

          // Shift/day breakdowns will only populate if present on the line
          if (line.morningShiftDays !== undefined) document.getElementById('morningDays').textContent = line.morningShiftDays;
          if (line.midShiftDays !== undefined) document.getElementById('midDays').textContent = line.midShiftDays;
          if (line.nightShiftDays !== undefined) document.getElementById('nightDays').textContent = line.nightShiftDays;
          if (line.otHours !== undefined) document.getElementById('otHours').textContent = line.otHours;

          // show run meta banner (create or update)
          const metaElId = 'payrollRunMetaBanner';
          let metaEl = document.getElementById(metaElId);
          const payrollInfo = document.getElementById('payroll-info');
          if (!metaEl) {
            metaEl = document.createElement('div');
            metaEl.id = metaElId;
            metaEl.className = 'payroll-meta';
            if (payrollInfo) payrollInfo.insertBefore(metaEl, document.getElementById('payrollDetails'));
          }
          const periodText = runMeta && runMeta.periodStart
            ? `${escapeHtml(runMeta.periodStart)} â†’ ${escapeHtml(runMeta.periodEnd)}`
            : 'Most recent saved run';
          metaEl.innerHTML = `<strong>Payroll run shown:</strong> ${periodText} ${runMeta && runMeta.note ? `<div class="meta-note">${escapeHtml(runMeta.note)}</div>` : ''}`;
        }

        function formatCurrency(v) {
          if (v === null || v === undefined || isNaN(Number(v))) return '-';
          return Number(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        function escapeHtml(s) {
          if (!s && s !== 0) return '';
          return String(s).replace(/[&<>\"]+/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]));
        }

      } catch (err) {
        console.error('Profile payroll init error', err);
      }
    })();
  </script>
</body>
</html>
